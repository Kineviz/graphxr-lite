services:
  rest:
    image: tabulario/iceberg-rest
    container_name: iceberg-rest
    networks:
      iceberg_net:
    ports:
      - 8181:8181
    volumes:
      - ./data/iceberg_rest:/app/data
      - ./data/iceberg_rest/catalog.properties:/app/iceberg-rest-catalog.properties:ro
    environment:
      - AWS_ACCESS_KEY_ID=admin
      - AWS_SECRET_ACCESS_KEY=password
      - AWS_REGION=us-east-1
      - CATALOG_WAREHOUSE=s3://warehouse/
      - CATALOG_IO__IMPL=org.apache.iceberg.aws.s3.S3FileIO
      - CATALOG_S3_ENDPOINT=http://minio:9000
      - CATALOG_CATALOG__IMPL=org.apache.iceberg.jdbc.JdbcCatalog
      - CATALOG_URI=jdbc:sqlite:file:/app/data/iceberg_rest_catalog.db
      - CATALOG_JDBC__INITIALIZE=true
    depends_on:
      mc:
        condition: service_completed_successfully
    restart: unless-stopped

  minio:
    image: minio/minio
    container_name: minio
    environment:
      - MINIO_ROOT_USER=admin
      - MINIO_ROOT_PASSWORD=password
      - MINIO_DOMAIN=minio
    networks:
      iceberg_net:
        aliases:
          - warehouse.minio
    ports:
      - 9901:9001
      - 9900:9000
    volumes:
      - ./data/minio:/data
    command: ["server", "/data", "--console-address", ":9001"]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3
    restart: unless-stopped

  mc:
    depends_on:
      minio:
        condition: service_healthy
    image: minio/mc
    container_name: mc
    networks:
      iceberg_net:
    environment:
      - AWS_ACCESS_KEY_ID=admin
      - AWS_SECRET_ACCESS_KEY=password
      - AWS_REGION=us-east-1
    entrypoint: >
      /bin/sh -c "
      echo 'Waiting for MinIO to be ready...';
      until (/usr/bin/mc alias set minio http://minio:9000 admin password) do echo '...waiting for MinIO...' && sleep 2; done;
      echo 'MinIO is ready, setting up buckets...';
      /usr/bin/mc mb minio/warehouse --ignore-existing;
      /usr/bin/mc anonymous set public minio/warehouse;
      echo 'Bucket setup completed successfully';
      exit 0
      "

  spark-iceberg:
    image: tabulario/spark-iceberg
    container_name: spark-iceberg
    build: spark/
    networks:
      iceberg_net:
    depends_on:
      rest:
        condition: service_started
      mc:
        condition: service_completed_successfully
    volumes:
      - ./init/warehouse:/home/iceberg/warehouse
      - ./init/notebooks:/home/iceberg/notebooks/notebooks
      - ./parquet_data:/parquet_data
      - ./data/spark/logs:/home/iceberg/spark/logs
      - ./data/spark/work:/home/iceberg/spark/work
      - ./init:/home/iceberg/init:ro
      - ./init/spark-defaults.conf:/opt/spark/conf/spark-defaults.conf:ro
    environment:
      - AWS_ACCESS_KEY_ID=admin
      - AWS_SECRET_ACCESS_KEY=password
      - AWS_REGION=us-east-1
      - PYSPARK_DRIVER_PYTHON=jupyter-notebook
      - PYSPARK_DRIVER_PYTHON_OPTS=--notebook-dir=/home/iceberg/notebooks --ip='*' --NotebookApp.token='kineviz123456' --NotebookApp.password='' --port=9888 --no-browser --allow-root
    entrypoint: ["/bin/bash", "/home/iceberg/init/init-spark.sh"]
    ports:
      - 9888:9888
    healthcheck:
      test: ["CMD", "test", "-f", "/tmp/init-completed"]
      interval: 10s
      timeout: 5s
      retries: 30
      start_period: 60s
    restart: unless-stopped

  puppygraph:
    image: puppygraph/puppygraph:0.95
    container_name: puppygraph
    networks:
      iceberg_net:
    environment:
      - PUPPYGRAPH_USERNAME=graphxr@kineviz.com
      - PUPPYGRAPH_PASSWORD=kineviz123456
    ports:
      - "9081:8081"
      - "8182:8182"
      - "9678:7687"
    volumes:
      - ./data/puppygraph:/data/storage
      - ./schema.json:/home/ubuntu/schema.json:ro
    depends_on:
      spark-iceberg:
        condition: service_healthy
      mc:
        condition: service_completed_successfully
    restart: unless-stopped

  mongo:
    image: mongo:latest
    container_name: graphxr-mongo
    networks:
      iceberg_net:
    volumes:
      - ./data/mongo:/data/db
    restart: unless-stopped

  graphxr:
    image: kineviz/graphxr_lite:puppygraph 
    container_name: graphxr
    networks:
      iceberg_net:
    ports:
      - "8080:9000"
    volumes:
      - ./data/graphxr:/data
    environment:
      # GraphXR admin user settings
      - ADMIN_EMAIL=graphxr@kineviz.com
      - ADMIN_PASSWORD=kineviz123456
      # Puppygraph connection settings
      - NEO4J_HOST=puppygraph
      - NEO4J_BOLT_PORT=7687
      - NEO4J_USERNAME=graphxr@kineviz.com
      - NEO4J_PASSWORD=kineviz123456
      - NEO4J_DATABASE=puppygraph
      # MongoDB connection settings
      - MONGO_URL=mongodb://mongo:27017/graphxr
    depends_on:
      puppygraph:
        condition: service_started
      mongo:
        condition: service_started
    restart: unless-stopped

networks:
  iceberg_net:
    name: puppy-iceberg


